# feat - Cross-Language Feature Documentation Tool

`feat` is a lightweight tool that discovers, inspects, and documents feature API surfaces across Rust, Python, and TypeScript codebases. It keeps documentation aligned with code through automatic sentinel block updates and provides cross-project feature lookup via a centralized brain registry.

## What It Does

- **Auto-discovers features** by scanning your project's module structure
- **Extracts public API surfaces** (functions, structs, enums, classes, etc.)
- **Updates documentation** using sentinel blocks for precise, non-invasive updates
- **Works across languages** with pluggable parser architecture
- **Syncs to brain registry** for cross-project feature documentation lookup

## Quick Start

### Installation

Deploy feat globally to use across all projects:

```bash
cd ~/repos/code/python/snekfx/feat-py
./bin/deploy.sh
```

This installs `feat` to `~/.local/bin/snek/feat`.

### Basic Usage

```bash
# Navigate to any Rust/Python project
cd ~/my-rust-project

# Initialize configuration (creates .spec.toml)
feat init

# List discovered features
feat list

# Inspect a feature's API surface
feat scan my_feature

# Update feature documentation
feat update my_feature

# Sync all feature docs (updates local + syncs to brain)
feat sync

# View features from other projects
feat projects                  # List all projects in brain
feat docs rsb global           # View RSB's global feature from anywhere
feat docs blade-py readme      # View blade-py README from anywhere
```

## Requirements

**feat requires:**
- Valid git repository (`.git` directory)
- Project manifest for configured languages:
  - **Rust**: `Cargo.toml` in repo root
  - **Python**: `pyproject.toml`, `setup.py`, or `setup.cfg` in repo root

The tool will error immediately if these requirements aren't met.

## Configuration

Create `.spec.toml` in your repository root:

```toml
# Where to scan for features (subdirectories = features)
features_root = "src"

# Where feature documentation lives
docs_root = "docs/feats"

# Documentation file naming pattern
doc_pattern = "FEATURES_{FEATURE}.md"

# Languages to parse
languages = ["rust"]

# Auto-discover features from features_root
auto_discover = true

# Exclusion patterns
exclude = [
    "**/tests/**",
    "**/target/**",
]

# Explicit feature mappings (override auto-discovery)
[features]
# my_feature = ["src/my_feature"]
```

Run `feat init` to generate this file with sensible defaults.

## How It Works

### 1. Repository Detection
Walks up from current directory to find `.git`, `Cargo.toml`, or other project markers.

### 2. Feature Discovery
- **Auto-discovery**: Scans `features_root` (default: `src/`), treats subdirectories as features
- **Explicit mapping**: Define features in `.spec.toml` `[features]` section

### 3. API Surface Extraction
Uses language-specific parsers to extract public items:

**Rust:**
- `pub fn`, `pub struct`, `pub enum`, `pub trait`, `pub type`
- `pub use` re-exports
- `#[macro_export]` macros

**Python:**
- Public classes (`class Foo`)
- Public functions (`def foo`)
- Public async functions (`async def foo`)

### 4. Documentation Updates
Updates or creates sentinel blocks in markdown files:

```markdown
<!-- feat:my_feature -->

_Generated by feat._

* `src/my_feature/core.rs`
  - fn process (line 42)
  - struct Config (line 10)

* `src/my_feature/utils.rs`
  - fn helper (line 7)

<!-- /feat:my_feature -->
```

Content outside sentinel blocks is preserved.

## Commands

| Command | Description |
|---------|-------------|
| `feat init` | Generate `.spec.toml` configuration |
| `feat list` | Show discovered features |
| `feat list --verbose` | Show features with file/item counts |
| `feat scan <feature>` | Inspect feature API surface |
| `feat scan <feature> --format json` | JSON output |
| `feat docs <feature>` | Display feature documentation (with boxy) |
| `feat docs <project> <feature>` | Display feature from any project in brain |
| `feat docs <project> readme` | Display project README from brain |
| `feat docs <feature> --view=data` | Plain output for AI/scripting |
| `feat update <feature>` | Update feature documentation |
| `feat update <feature> --doc <path>` | Update specific doc file |
| `feat sync` | Update all feature docs + sync to brain |
| `feat sync --dry-run` | Preview changes without writing |
| `feat projects` | List all projects in brain registry |
| `feat check` | Validate configuration |
| `feat check --missing-docs` | Report missing documentation |

## Workflow Examples

### Starting a New Project

```bash
cd my-rust-project
feat init                   # Generate .spec.toml
feat list                   # See auto-discovered features
feat sync                   # Generate stub docs for all features
```

### After Refactoring

```bash
feat sync                   # Update all feature docs
git diff docs/              # Review documentation changes
git add docs/ && git commit -m "Update feature docs"
```

### Documenting a Specific Feature

```bash
feat scan colors            # See what's in the feature
feat update colors          # Update/create docs
# Edit docs/feats/FEATURES_COLORS.md manually
feat update colors          # Re-run to update sentinel block
feat docs colors            # Display documentation (pretty with boxy)
feat docs colors --view=data # Plain output for AI
```

## Language Support

| Language | Status | Parser |
|----------|--------|--------|
| Rust | âœ… Full | Regex-based extraction |
| Python | âœ… Full | Regex-based extraction |
| TypeScript | ðŸš§ Stub | Not implemented |

## Design Philosophy

**Convention over configuration**
- Works zero-config in standard project layouts
- Auto-discovers features from directory structure
- Sensible defaults for everything

**Lightweight parsing**
- No compiler dependencies
- Fast regex-based extraction
- Portable across platforms

**Non-invasive documentation**
- Only updates designated sentinel blocks
- Manual content outside blocks preserved
- Version control friendly

## Brain Registry

`feat sync` automatically syncs feature documentation to a centralized brain registry at `~/repos/docs/brain/dev/proj/feat/`, enabling cross-project feature lookup.

**How it works:**
1. Run `feat sync` in any project to update docs and sync to brain
2. Brain stores: `<project>/.spec.toml` + `README.md` + all `FEATURES_*.md` files
3. Access features from any project using `feat docs <project> <feature>`
4. Access READMEs using `feat docs <project> readme`

**Project name detection (fallback chain):**
1. `.spec.toml` - `project_name = "my-project"`
2. `Cargo.toml` - `[package] name`
3. Directory name (e.g., `rsb` from `/path/to/rsb/`)

**Commands:**
```bash
# Sync current project to brain
cd ~/my-project
feat sync

# View all projects in brain
feat projects

# View feature from another project (from anywhere)
feat docs rsb global
feat docs my-project networking

# View project README
feat docs blade-py readme
feat docs feat-py readme
```

**Brain structure:**
```
~/repos/docs/brain/dev/proj/feat/
â”œâ”€â”€ rsb/
â”‚   â”œâ”€â”€ .spec.toml
â”‚   â”œâ”€â”€ README.md
â”‚   â”œâ”€â”€ FEATURES_GLOBAL.md
â”‚   â”œâ”€â”€ FEATURES_CLI.md
â”‚   â””â”€â”€ ...
â”œâ”€â”€ blade-py/
â”‚   â”œâ”€â”€ .spec.toml
â”‚   â””â”€â”€ README.md          # README-only projects work too!
â”œâ”€â”€ my-project/
â”‚   â”œâ”€â”€ .spec.toml
â”‚   â”œâ”€â”€ README.md
â”‚   â””â”€â”€ FEATURES_*.md
```

**README-only projects:**
Projects without feature modules can still sync their README to brain:
```toml
# .spec.toml for README-only projects
project_name = "my-tool"
languages = ["python"]
auto_discover = false  # No features to discover
```

## Boxy Integration

feat supports optional pretty output via [boxy](https://github.com/your-org/boxy):

```bash
# Pretty display with boxy (default)
feat docs global

# Plain output for AI/scripting
feat docs global --view=data

# Disable boxy globally
export REPOS_USE_BOXY=1  # Shell convention: 1=disabled
feat docs global
```

**Features:**
- Automatic fallback if boxy not available
- Themed borders and titles
- `--view=data` mode for plain output (AI-friendly)

## Advanced Usage

### Explicit Feature Mappings

Override auto-discovery for complex layouts:

```toml
[features]
# Map feature name to multiple source paths
networking = ["src/net", "src/protocols"]
storage = ["src/db", "src/cache"]
```

### Custom Documentation Paths

```bash
# Update custom doc file
feat update my_feature --doc docs/custom/my-doc.md
```

### Multi-Language Projects

```toml
languages = ["rust", "python"]
```

The tool will parse both `.rs` and `.py` files, detect primary language by file count.

## Troubleshooting

**Error: not in a repository**
- feat requires a valid git repo with `.git` directory
- Ensure you're inside a repository

**Error: rust language configured but Cargo.toml not found**
- feat validates language requirements strictly
- Add `Cargo.toml` or update `languages` in `.spec.toml`

**No features discovered**
- Check `features_root` points to correct directory
- Verify directory has subdirectories (each = one feature)
- Use `feat check` to diagnose issues

**Parsing errors**
- Check file encoding (UTF-8 required)
- Complex nested declarations may be missed (regex limitations)

## Documentation

- **[USING_FEAT.md](docs/USING_FEAT.md)** - Comprehensive usage guide
- **[QUICK_START.md](docs/QUICK_START.md)** - Quick start tutorial
- **[FEAT_PATTERNS.md](docs/FEAT_PATTERNS.md)** - Pattern analysis across projects
- **[docs/examples/](docs/examples/)** - Real-world examples

## Architecture

```
feat-py/
â”œâ”€â”€ feat.py              # Main script (1087 lines)
â”œâ”€â”€ bin/deploy.sh        # Deployment script
â”œâ”€â”€ pyproject.toml       # pip package config
â””â”€â”€ docs/
    â”œâ”€â”€ USING_FEAT.md    # Usage guide
    â”œâ”€â”€ FEAT_PATTERNS.md # Pattern reference
    â””â”€â”€ examples/        # Example configs
```

**Core components:**
- `RepoContext` - Repository detection and validation
- `Config` - Configuration loading and validation
- `Discovery` - Feature auto-discovery
- `Parser` - Language-specific API extraction
- `DocUpdater` - Sentinel block management

## Contributing

Contributions welcome:
- Additional language parsers (Go, C++, Java, etc.)
- Enhanced TypeScript support
- Improved pattern matching
- Test coverage

## License

MIT License

## Related Tools

- [rustdoc](https://doc.rust-lang.org/rustdoc/) - Official Rust documentation
- [Sphinx](https://www.sphinx-doc.org/) - Python documentation builder
- [TypeDoc](https://typedoc.org/) - TypeScript documentation

`feat` complements these by providing lightweight, cross-language feature inventories in markdown format for multi-language projects.

---

**Version:** 2.0.0
**Status:** âœ… Production Ready
**Deployment:** `./bin/deploy.sh`
